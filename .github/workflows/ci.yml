on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  main:
    runs-on: ubuntu-22.04

    env:
      IS_TEST: ${{ startsWith(github.ref, 'refs/pull') }}
      IS_PROD: ${{ startsWith(github.ref, 'refs/heads/main') }}
      DISCORD_INCOMING_WEBHOOK: ${{ secrets.DISCORD_INCOMING_WEBHOOK }}

    steps:
      # æ¨™æº–æ©Ÿèƒ½
      - uses: actions/checkout@v4

      # Protoã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: true

      # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - uses: actions/cache@v3
        id: bun-cache
        with:
          path: node_modules
          key: bun-${{ hashFiles('bun.lockb') }}
          restore-keys: bun-

      # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å¼•ã£ã‹ã‹ã‚‰ãªã‹ã£ãŸæ™‚ã®ã¿)
      - name: Install
        if: steps.bun-cache.outputs.cache-hit != 'true'
        run: bun install --no-save

      # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
      - name: Set env
        run: |
          echo URL_PROD=\'${{ secrets.URL_PROD }}\' >> .env.toml
      - name: Set TEST env
        if: env.IS_TEST == 'true'
        run: |
          echo ENVIRONMENT=\'TEST\' >> .env.toml
          echo "DISCORD_PREFIX=ğŸ§ª Updated TEST env: " >> $GITHUB_ENV
      - name: Set PROD env
        if: env.IS_PROD == 'true'
        run: |
          echo ENVIRONMENT=\'PROD\' >> .env.toml
          echo "DISCORD_PREFIX=ğŸš€ Released PROD env: " >> $GITHUB_ENV

      # ãƒ“ãƒ«ãƒ‰
      # ãƒ“ãƒ«ãƒ‰ç›´å‰ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç›´æ¥ä¸Šæ›¸ãã«ã‚ˆã‚‹OGPã®è¨­å®šå¤‰æ›´
      - name: Build
        run: |
          sed -i '32a worker.get("/opengraph-image.jpg",serveStatic())' node_modules/@hono/vite-cloudflare-pages/dist/entry.js
          sed -i '32a worker.get("/favicon.svg",serveStatic())' node_modules/@hono/vite-cloudflare-pages/dist/entry.js
          sed -i '32a worker.get("/apple-touch-icon.png",serveStatic())' node_modules/@hono/vite-cloudflare-pages/dist/entry.js
          bun run build

      # ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./dist --project-name="${{ secrets.CLOUDFLARE_PROJECT_NAME }}" --branch="foo" --commit-dirty=true

      # Discordã«é€šçŸ¥
      - name: Notify Discord
        run: |
          curl -H 'Content-Type:application/json' -d "{\"content\": \"$DISCORD_PREFIX $DEPLOYMENT_URL\"}" $DISCORD_INCOMING_WEBHOOK
        env:
          DEPLOYMENT_URL: ${{ steps.deploy.outputs.deployment-url }}
